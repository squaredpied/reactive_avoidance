Bootstrap: docker
From: ros:melodic

%setup
    mkdir -p ${SINGULARITY_ROOTFS}/jackal_ws/src

%files
    . /jackal_ws/src/the-barn-challenge

%post -c /bin/bash
    apt-get update && export DEBIAN_FRONTEND=noninteractive \
    && apt-get -y install --no-install-recommends \
    wget python3-venv build-essential cmake\
    protobuf-compiler libprotobuf-dev libglib2.0-dev libc6-dev glibc-source \
    gazebo9 libgazebo9-dev libjansson-dev libboost-dev imagemagick libtinyxml-dev mercurial \
    libgoogle-glog-dev libgtest-dev libgflags-dev python3-dev xserver-xorg x11-apps

    # Remove the existing CMake
    #apt-get remove -y cmake

    # Install specific version of CMake
    CMAKE_VERSION=3.20.0
    wget https://github.com/Kitware/CMake/releases/download/v${CMAKE_VERSION}/cmake-${CMAKE_VERSION}.tar.gz
    tar -zxf cmake-${CMAKE_VERSION}.tar.gz
    cd cmake-${CMAKE_VERSION}
    ./bootstrap && make -j15 && make install
    cd ..
    rm -rf cmake-${CMAKE_VERSION}*

    cmake -DCMAKE_PREFIX_PATH="/usr/include/eigen3" ..


    # Install CUDA Toolkit 12.0
    wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu1804/x86_64/cuda-keyring_1.0-1_all.deb
    sudo dpkg -i cuda-keyring_1.0-1_all.deb
    sudo apt-get update
    sudo apt-get -y install cuda
    export PATH=/usr/local/cuda/bin${PATH:+:${PATH}}
    export LD_LIBRARY_PATH=/usr/local/cuda/lib64\
                         ${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}

    python3 -m venv /venv
    export PATH="/venv/bin:$PATH"
    pip3 install --upgrade pip
    pip3 install defusedxml rospkg netifaces numpy
    
    apt-get install -y ros-melodic-desktop-full ros-melodic-gmapping \
    ros-melodic-robot-localization ros-melodic-joint-state-publisher-gui ros-melodic-navigation \
    ros-melodic-hector-gazebo-plugins ros-melodic-velodyne-description ros-melodic-rosdoc-lite \
    ros-melodic-twist-mux ros-melodic-sick-tim ros-melodic-teleop-twist-joy ros-melodic-teleop-twist-keyboard ros-melodic-pointgrey-camera-description \
    ros-melodic-interactive-marker-twist-server ros-melodic-lms1xx ros-melodic-laser-pipeline ros-melodic-controller-manager \
    ros-melodic-gazebo-dev ros-melodic-hector-mapping 

    
    cd /jackal_ws/src
    git clone https://github.com/jackal/jackal.git --branch melodic-devel
    git clone https://github.com/jackal/jackal_simulator.git --branch melodic-devel
    git clone https://github.com/jackal/jackal_desktop.git --branch melodic-devel
    #git clone https://github.com/utexas-bwi/eband_local_planner.git
    git clone https://github.com/catkin/catkin_simple.git
    git clone https://github.com/ethz-asl/eigen_catkin.git
    wstool update

    cd /usr/src/googletest && sudo cmake . && sudo cmake --build . --target install

    source /opt/ros/melodic/setup.bash
    cd /jackal_ws
    rosdep init; rosdep update
    rosdep install -y --from-paths . --ignore-src --rosdistro=melodic
    source devel/setup.bash
    catkin_make

%environment
    export PATH="/venv/bin:$PATH"
    export DISPLAY=$DISPLAY
    export QT_X11_NO_MITSHM=1

    export CUDA_HOME=/usr/local/cuda
    export PATH=$CUDA_HOME/bin:$PATH
    export LD_LIBRARY_PATH=$CUDA_HOME/lib64:$LD_LIBRARY_PATH


%runscript
    #!/bin/bash
    echo "Starting xclock to test X11 forwarding"
    xclock
